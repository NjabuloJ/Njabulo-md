import moment from "moment-timezone";
import fs from "fs";
import os from "os";
import pkg from "baileys-pro";
const { generateWAMessageFromContent, proto } = pkg;
import config from "../config.cjs";
import axios from "axios";

//N◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶ Time logic‚ö†Ô∏é
const xtime = moment.tz("Africa/Nairobi").format("HH:mm:ss");
const xdate = moment.tz("Africa/Nairobi").format("DD/MM/YYYY");
const time2 = moment().tz("Africa/Nairobi").format("HH:mm:ss");
let pushwish = "";

if (time2 < "05:00:00") {
  njabulojb = `Good Morning`;
} else if (time2 < "11:00:00") {
  njabulojb = `Good Morning`;
} else if (time2 < "15:00:00") {
  njabulojb = `Good Afternoon`;
} else if (time2 < "18:00:00") {
  njabulojb = `Good Evening`;
} else if (time2 < "19:00:00") {
  njabulojb = `Good Evening`;
} else {
  njabulojb = `Good Night`;
}

//N◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶ Fancy font utility‚ö†Ô∏é
function toFancyFont(text, isUpperCase = false) {
  const fonts = {
 'a': '·¥Ä', 'b': ' ô', 'c': '·¥Ñ', 'd': '·¥Ö', 'e': '·¥á', 'f': '“ì', 'g': '…¢', 'h': ' ú', 'i': '…™', 'j': '·¥ä', 'k': '·¥ã', 'l': ' ü', 'm': '·¥ç',
 'n': '…¥', 'o': '·¥è', 'p': '·¥ò', 'q': '«´', 'r': ' Ä', 's': 's', 't': '·¥õ', 'u': '·¥ú', 'v': '·¥†', 'w': '·¥°', 'x': 'x', 'y': ' è', 'z': '·¥¢'
  };
  const formattedText = isUpperCase ? text.toUpperCase() : text.toLowerCase();
  return formattedText
    .split("")
    .map((char) => fonts[char] || char)
    .join("");
}

//N◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶ Image fetch utility‚ö†Ô∏é
async function fetchMenuImage() {
  const imageUrl = "https://files.catbox.moe/wu6lu4.jpg";
  for (let i = 0; i < 3; i++) {
    try {
      const response = await axios.get(imageUrl, { responseType: "arraybuffer" });
      return Buffer.from(response.data, "binary");
    } catch (error) {
      if (error.response?.status === 429 && i < 2) {
        console.log(`Rate limit hit, retrying in 2s...`);
        await new Promise((resolve) => setTimeout(resolve, 2000));
        continue;
      }
      console.error("‚ùå Failed to fetch image:", error);
      return null;
    }
  }
}

const menu = async (m, Matrix) => {
  try {
    const prefix = config.PREFIX;
    const cmd = m.body.startsWith(prefix) ? m.body.slice(prefix.length).split(" ")[0].toLowerCase() : "";
    const mode = config.MODE === "public" ? "public" : "private";
    const totalCommands = 70;

    const validCommands = ["list", "help", "menu"];
    const subMenuCommands = [
      "commands",
      "channel-update",
    ];

    // Fetch image for all cases
    const menuImage = await fetchMenuImage();

    // Handle main menu
    if (validCommands.includes(cmd)) {
      const mainMenu = `
‚îè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ä∑
‚îä ô·¥è·¥õ …¥·¥Ä·¥ç·¥á  *N◊†…ê·Ç¶œÖ‚ÑìœÉ ◊†·Ç¶*
‚îä*${toFancyFont("Total Commands")}*: ${totalCommands}
‚îä*${toFancyFont("Prefix")}*: ${prefix}
‚îä*${toFancyFont("Mode")}*: ${mode}
‚îä *${toFancyFont("Library")}*: Baileys
‚îó‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ä∑

${pushwish} @*${m.pushName}*! Tap a button to select a menu category:

> PœÉ…Ø“Ω…æ“Ω‘É ·Ç¶·Éß Makamesco-…±‘É
`;

      const messageOptions = {
        viewOnce: true,
        buttons: [
          {
            buttonId: `${prefix}commands`,
            buttonText: { displayText: ` ${toFancyFont("commands")}` },
            type: 1,
          },
          {
            buttonId: `${prefix} channel-update`,
            buttonText: { displayText: ` ${toFancyFont("channel-update")}` },
            type: 1,
          },
        ],
        contextInfo: {
          mentionedJid: [m.sender],
          externalAdReply: {
            showAdAttribution: true, // Marks as an ad
            title: `${toFancyFont("Makamesco-MD")} Menu`,
            body: `${pushwish} Explore Makamesco-MD's features!`,
            sourceUrl: "https://github.com/makamesco/Makamesco-md-v",
            mediaType: 1,
            renderLargerThumbnail: true,
            mediaUrl: "https://files.catbox.moe/wu6lu4.jpg",
          },
        },
      };

      // Send menu with or without image
      if (menuImage) {
        await Matrix.sendMessage(
          m.from,
          { image: menuImage, caption: mainMenu, ...messageOptions },
          { quoted: m }
        );
      } else {
        await Matrix.sendMessage(m.from, { text: mainMenu, ...messageOptions }, { quoted: m });
      }

      // Send audio as a voice note
      await Matrix.sendMessage(
        m.from,
        { audio: { url: "https://files.catbox.moe/f4zaz4.mp3" }, mimetype: "audio/mp4", ptt: true },
        { quoted: m }
      );
    }

    // Handle sub-menu commands
    if (subMenuCommands.includes(cmd)) {
      let menuTitle;
      let menuResponse;

      switch (cmd) {
        case "commands":
          menuTitle = "commands";
          menuResponse = `
‚îè‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ä∑
‚îä‚òπ ô·¥è·¥õ …¥·¥Ä·¥ç·¥á :  *…¥·¥ä·¥Ä ô·¥ú ü·¥è ·¥ä ô*
‚îó‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ä∑
‚îè 
*„Äê${toFancyFont("Download")}„Äë*
‚îó
‚îè
- .‚ë† ${toFancyFont("apk")}
- .‚ë° ${toFancyFont("facebookapk")}
- .‚ë¢ ${toFancyFont("mediafireapk")}
- .‚ë£ ${toFancyFont("pintersapk")}
- .‚ë§ ${toFancyFont("gitcloneapk")}
- .‚ë• ${toFancyFont("gdriveapk")}
- .‚ë¶ ${toFancyFont("instaapk")}
- .‚ëß ${toFancyFont("ytmp3apk")}
- .‚ë® ${toFancyFont("ytmp4apk")}
- .‚ë© ${toFancyFont("playapk")}
- .‚ë™ ${toFancyFont("song")}
- .‚ë´ ${toFancyFont("video")}
- .‚ë¨ ${toFancyFont("ytmp")}
- .‚ë≠ ${toFancyFont("ytmp4")}
- .‚ëÆ ${toFancyFont("tiktok")}
‚îó
‚îè
- . ${toFancyFont("*Converter*")} 
- . ${toFancyFont("attp")}*
- . ${toFancyFont("attp2")}*
- . ${toFancyFont("attp3")}*
- . ${toFancyFont("ebinary")}*
- . ${toFancyFont("dbinary")}*
- . ${toFancyFont("emojimix")}*
- . *${toFancyFont("mp3")}*
‚îó
‚îè
- . ${toFancyFont("AI")} ü§ñ
- . ${toFancyFont("ai")}*
- . ${toFancyFont("bug")}*
- . ${toFancyFont("report")}*
- . ${toFancyFont("gpt")}*
- . ${toFancyFont("dalle")}*
- . ${toFancyFont("remini")}*
- . ${toFancyFont("gemini")}*
‚îó
‚îè
- . ${toFancyFont("Tools")} üõ†
- . ${toFancyFont("calculator")}*
- . ${toFancyFont("tempmail")}*
- . ${toFancyFont("checkmail")}*
- . ${toFancyFont("trt")}*
- . ${toFancyFont("tts")}*
‚îó
‚îè
- .  ${toFancyFont("Group")} üë•
- . ${toFancyFont("linkgroup")}*
- . ${toFancyFont("setppgc")}*
- . ${toFancyFont("setname")}*
- . ${toFancyFont("setdesc")}*
- . ${toFancyFont("group")}*
- . ${toFancyFont("gcsetting")}*
- . ${toFancyFont("welcome")}*
- . ${toFancyFont("add")}*
- . ${toFancyFont("kick")}*
- . ${toFancyFont("hidetag")}*
- . ${toFancyFont("tagall")}*
- . ${toFancyFont("antilink")}*
- . ${toFancyFont("antitoxic")}*
- . ${toFancyFont("promote")}*
- . ${toFancyFont("demote")}*
- . ${toFancyFont("getbio")}*
‚îó
‚îè
- .  ${toFancyFont("Search")} üîç
- . ${toFancyFont("play")}*
- . ${toFancyFont("yts")}*
- . ${toFancyFont("imdb")}*
- . ${toFancyFont("google")}*
- . ${toFancyFont("gimage")}*
- . ${toFancyFont("pinterest")}*
- . ${toFancyFont("wallpaper")}*
- . ${toFancyFont("wikimedia")}*
- . ${toFancyFont("ytsearch")}*
- . ${toFancyFont("ringtone")}*
- . ${toFancyFont("lyrics")}*
‚îó
‚îè
- . ${toFancyFont("Main")} ‚öô
- . ${toFancyFont("ping")}*
- . ${toFancyFont("alive")}*
- . ${toFancyFont("owner")}*
- . ${toFancyFont("menu")}*
- . ${toFancyFont("infobot")}*
‚îó
‚îè
- . ${toFancyFont("Owner")} üîí
- . ${toFancyFont("join")}*
- . ${toFancyFont("leave")}*
- . ${toFancyFont("block")}*
- . ${toFancyFont("unblock")}*
- . ${toFancyFont("setppbot")}*
- . ${toFancyFont("anticall")}*
- . ${toFancyFont("setstatus")}*
- . ${toFancyFont("setnamebot")}*
- . ${toFancyFont("autorecording")}*
- . ${toFancyFont("autolike")}*
- . ${toFancyFont("autotyping")}*
- . ${toFancyFont("alwaysonline")}*
- . ${toFancyFont("autoread")}*
- . ${toFancyFont("autosview")}*
‚îó
`;
          break;

        default:
          return;
      }

      // Format the full response
      const fullResponse = `
‚óà‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚óà
‚îÇ‚ùí ${toFancyFont("Makamesco-MD")} - ${toFancyFont(menuTitle)} ‚ö†
‚îÇ
‚îÇ ü§ñ *${toFancyFont("Bot")}*: ${toFancyFont("Makamesco-MD")}
‚îÇ üë§ *${toFancyFont("User")}*: ${m.pushName}
‚îÇ üî£ *${toFancyFont("Prefix")}*: ${prefix}
‚îÇ üìö *${toFancyFont("Library")}*: Baileys
‚óà‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚óà

${menuResponse}

> PœÉ…Ø“Ω…æ“Ω‘É ·Ç¶·Éß Makamesco-…±‘É
`;

      // Send sub-menu with or without image
      if (menuImage) {
        await Matrix.sendMessage(
          m.from,
          {
            image: menuImage,
            caption: fullResponse,
            contextInfo: {
              mentionedJid: [m.sender],
              externalAdReply: {
                showAdAttribution: true, // Marks as an ad
                title: `${toFancyFont("Makamesco-MD")} ${toFancyFont(menuTitle)}`,
                body: `Explore Makamesco-MD's ${menuTitle.toLowerCase()} commands!`,
                sourceUrl: "https://github.com/makamesco/Makamesco-md-v",
                mediaType: 1,
                renderLargerThumbnail: true,
                mediaUrl: "https://files.catbox.moe/wu6lu4.jpg",
              },
            },
          },
          { quoted: m }
        );
      } else {
        await Matrix.sendMessage(m.from, {
          text: fullResponse,
          contextInfo: {
            mentionedJid: [m.sender],
            externalAdReply: {
              showAdAttribution: true, // Marks as an ad
              title: `${toFancyFont("Makamesco-MD")} ${toFancyFont(menuTitle)}`,
              body: `Explore Makamesco-MD's ${menuTitle.toLowerCase()} commands!`,
              sourceUrl: "https://github.com/makamesco/Makamesco-md-v",
              mediaType: 1,
              renderLargerThumbnail: true,
            },
          },
        }, { quoted: m });
      }
    }
  } catch (error) {
    console.error(`‚ùå Menu error: ${error.message}`);
    await Matrix.sendMessage(m.from, {
      text: `‚óà‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚óà
‚îÇ‚ùí *Makamesco-MD* hit a snag! Error: ${error.message || "Failed to load menu"} üò°
‚óà‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚óà`,
    }, { quoted: m });
  }
};

export default menu;
